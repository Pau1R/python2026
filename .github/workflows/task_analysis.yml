name: Lesson Task Analysis

on:
  push:
    paths:
      - "students/**/lessons/**/homework/**"
      - "students/**/lessons/**/tasks/**"
  workflow_call:
    inputs:
      base_sha:
        required: false
        type: string

jobs:
  analyze:
    if: github.repository != 'Pau1R/python2026'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Collect new solution files
        id: collect
        shell: bash
        env:
          INPUT_BASE_SHA: ${{ inputs.base_sha }}
          EVENT_BEFORE: ${{ github.event.before }}
        run: |
          set -euo pipefail

          BASE="$INPUT_BASE_SHA"
          if [[ -z "$BASE" ]]; then
            BASE="$EVENT_BEFORE"
          fi
          if [[ -z "$BASE" || "$BASE" == "0000000000000000000000000000000000000000" ]]; then
            BASE="$(git rev-list --max-parents=0 HEAD)"
          fi

          CHANGED="$(git diff --name-only "$BASE" HEAD)"
          if [[ -z "$CHANGED" ]]; then
            echo "No files changed. Skipping analysis."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          NEW_FILES="$(git diff --diff-filter=A --name-only "$BASE" HEAD)"

          MODE=""
          TASK_NUM=""
          SOLUTION_DIR=""
          MATCHED=()
          while IFS= read -r PATH; do
            [[ -z "$PATH" ]] && continue
            if [[ "$PATH" =~ ^students/.+/lessons/.+/homework/[^/]+homework\.py$ ]]; then
              CURRENT_MODE="homework"
              CURRENT_TASK=""
            elif [[ "$PATH" =~ ^students/.+/lessons/.+/tasks/.+/task_([0-9]{1,2})\.py$ ]]; then
              CURRENT_MODE="task"
              CURRENT_TASK="${BASH_REMATCH[1]}"
            else
              continue
            fi

            if ! grep -Fxq "$PATH" <<<"$NEW_FILES"; then
              echo "Skipping analysis because $PATH is not a newly added solution file."
              echo "skip=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            CURRENT_DIR="$(dirname "$PATH")"

            if [[ -z "$MODE" ]]; then
              MODE="$CURRENT_MODE"
              TASK_NUM="$CURRENT_TASK"
              SOLUTION_DIR="$CURRENT_DIR"
            else
              if [[ "$MODE" != "$CURRENT_MODE" ]]; then
                echo "Found both homework and task solutions in the same push. Skipping analysis."
                echo "skip=true" >> "$GITHUB_OUTPUT"
                exit 0
              fi
              if [[ "$MODE" == "task" && "$TASK_NUM" != "$CURRENT_TASK" ]]; then
                echo "Found multiple task numbers in the same push. Skipping analysis."
                echo "skip=true" >> "$GITHUB_OUTPUT"
                exit 0
              fi
              if [[ "$SOLUTION_DIR" != "$CURRENT_DIR" ]]; then
                echo "Solution files are in different directories. Skipping analysis."
                echo "skip=true" >> "$GITHUB_OUTPUT"
                exit 0
              fi
            fi

            MATCHED+=("$PATH")
          done < <(printf "%s\n" "$CHANGED")

          if [[ "${#MATCHED[@]}" -eq 0 ]]; then
            echo "No solution files detected. Skipping analysis."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TARGETS=()
          while IFS= read -r PATH; do
            [[ -z "$PATH" ]] && continue
            if [[ "$PATH" == "$SOLUTION_DIR" || "$PATH" == "$SOLUTION_DIR"/* ]]; then
              abs_path="$(realpath "$PATH")"
              if [[ -f "$abs_path" ]]; then
                TARGETS+=("$PATH")
              fi
            fi
          done < <(printf "%s\n" "$CHANGED")

          {
            echo "skip=false"
            echo "mode=$MODE"
            echo "task=$TASK_NUM"
            echo "dir=$SOLUTION_DIR"
            echo "solutions<<EOF"
            printf "%s\n" "${MATCHED[@]}" | sort -u
            echo "EOF"
            echo "files<<EOF"
            printf "%s\n" "${TARGETS[@]}" | sort -u
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Resolve lesson metadata
        id: meta
        if: steps.collect.outputs.skip != 'true'
        shell: bash
        env:
          MODE: ${{ steps.collect.outputs.mode }}
          TASK: ${{ steps.collect.outputs.task }}
          DIR: ${{ steps.collect.outputs.dir }}
        run: |
          set -euo pipefail

          if [[ "$MODE" == "homework" ]]; then
            DESC="$DIR/homework.md"
            REPORT="$DIR/homework_report.md"
          else
            DESC="$DIR/task_${TASK}.md"
            REPORT="$DIR/task_${TASK}_report.md"
          fi

          if [[ ! -f "$DESC" ]]; then
            echo "Expected description file $DESC not found." >&2
            exit 1
          fi

          {
            echo "description=$DESC"
            echo "report=$REPORT"
          } >> "$GITHUB_OUTPUT"

      - name: Read student submission and task description
        id: content
        if: steps.collect.outputs.skip != 'true'
        shell: bash
        env:
          FILES: ${{ steps.collect.outputs.files }}
          DESCRIPTION: ${{ steps.meta.outputs.description }}
        run: |
          set -euo pipefail

          {
            echo "solution<<EOF"
            while IFS= read -r FILE; do
              [[ -z "$FILE" ]] && continue
              if [[ ! -f "$FILE" ]]; then
                continue
              fi
              echo "### $FILE"
              echo
              cat "$FILE"
              echo
            done <<<"$FILES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          {
            echo "description<<EOF"
            cat "$DESCRIPTION"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Load analysis template
        id: template
        if: steps.collect.outputs.skip != 'true'
        shell: bash
        env:
          TEMPLATE_URL: https://raw.githubusercontent.com/Pau1R/python2026/main/tools/task_autocheck_promt.md
        run: |
          set -euo pipefail

          TEMPLATE_CONTENT="$(curl -fsSL "$TEMPLATE_URL")"
          if [[ -z "$TEMPLATE_CONTENT" ]]; then
            echo "Failed to load template from $TEMPLATE_URL" >&2
            exit 1
          fi

          {
            echo "body<<EOF"
            printf "%s\n" "$TEMPLATE_CONTENT"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Compose Copilot prompt
        id: prompt
        if: steps.collect.outputs.skip != 'true'
        shell: bash
        env:
          TEMPLATE: ${{ steps.template.outputs.body }}
          DESCRIPTION: ${{ steps.content.outputs.description }}
          SOLUTION: ${{ steps.content.outputs.solution }}
        run: |
          set -euo pipefail

          {
            echo "prompt<<EOF"
            printf "%s\n\n" "$TEMPLATE"
            echo "Task description:"
            echo "---"
            printf "%s\n" "$DESCRIPTION"
            echo "---"
            echo
            echo "Student's solution:"
            echo "---"
            printf "%s\n" "$SOLUTION"
            echo "---"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Copilot Task Analysis
        id: copilot
        if: steps.collect.outputs.skip != 'true'
        uses: github/copilot-actions@v1
        with:
          instructions: ${{ steps.prompt.outputs.prompt }}
          temperature: 0.1


      - name: Save report
        if: steps.collect.outputs.skip != 'true'
        shell: bash
        env:
          REPORT: ${{ steps.meta.outputs.report }}
          RESPONSE: ${{ steps.copilot.outputs.response }}
        run: |
          set -euo pipefail
          printf "%s\n" "$RESPONSE" > "$REPORT"
          echo "Report saved to $REPORT"

      - name: Upload analysis artifact
        if: steps.collect.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: analysis-report
          path: ${{ steps.meta.outputs.report }}
